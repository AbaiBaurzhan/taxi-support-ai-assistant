<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¢–∞–∫—Å–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--tg-theme-header-bg-color, #2481cc);
            color: var(--tg-theme-header-text-color, #ffffff);
            padding: 16px;
            text-align: center;
            font-weight: 600;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            align-self: flex-end;
            margin-left: auto;
        }

        .message.bot {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
            align-self: flex-start;
        }

        .message.system {
            background: var(--tg-theme-hint-color, #999999);
            color: var(--tg-theme-secondary-bg-color, #ffffff);
            align-self: center;
            font-size: 12px;
            max-width: 90%;
        }

        .input-container {
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            outline: none;
        }

        .send-button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-buttons {
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-button {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
            border: none;
            border-radius: 16px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .quick-button:hover {
            background: var(--tg-theme-hint-color, #e0e0e0);
        }

        .loading {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--tg-theme-hint-color, #999999);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            color: var(--tg-theme-hint-color, #999999);
            font-style: italic;
        }

        .typing-indicator.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        üöó –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¢–∞–∫—Å–∏
    </div>

    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="message system">
                üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ —Ç–∞–∫—Å–∏.
            </div>
        </div>

        <div class="quick-buttons" id="quickButtons">
            <button class="quick-button" onclick="sendQuickMessage('–ì–¥–µ –º–æ–π –≤–æ–¥–∏—Ç–µ–ª—å?')">–ì–¥–µ –≤–æ–¥–∏—Ç–µ–ª—å?</button>
            <button class="quick-button" onclick="sendQuickMessage('–ü—Ä–∏—à–ª–∏—Ç–µ —á–µ–∫')">–ü—Ä–∏—à–ª–∏—Ç–µ —á–µ–∫</button>
            <button class="quick-button" onclick="sendQuickMessage('–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ü–µ–Ω–∞?')">–¶–µ–Ω–∞ –ø–æ–µ–∑–¥–∫–∏</button>
            <button class="quick-button" onclick="sendQuickMessage('–ö–∞–∫–∏–µ —É –º–µ–Ω—è –∫–∞—Ä—Ç—ã?')">–ú–æ–∏ –∫–∞—Ä—Ç—ã</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <span>–û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ...</span>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            –ë–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...
        </div>

        <div class="input-container">
            <input 
                type="text" 
                class="input-field" 
                id="messageInput" 
                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."
                onkeypress="handleKeyPress(event)"
            >
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                ‚û§
            </button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = tg.initDataUnsafe?.user;
        const userId = user?.id?.toString() || 'user_123';
        const locale = user?.language_code || 'ru';

        // API URL
        const API_URL = 'http://localhost:8000';

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loading = document.getElementById('loading');
        const typingIndicator = document.getElementById('typingIndicator');

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addMessage(text, 'user');
            messageInput.value = '';
            sendButton.disabled = true;
            loading.classList.add('show');

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        user_id: userId,
                        locale: locale
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
                loading.classList.remove('show');
                typingIndicator.classList.add('show');
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—á–∞—Ç–∏
                setTimeout(() => {
                    typingIndicator.classList.remove('show');
                    addMessage(data.response, 'bot');
                }, 1000 + Math.random() * 1000);

            } catch (error) {
                console.error('Error:', error);
                loading.classList.remove('show');
                addMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'bot');
            } finally {
                sendButton.disabled = false;
            }
        }

        // –ë—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendQuickMessage(text) {
            messageInput.value = text;
            sendMessage();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
            addMessage('–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', 'bot');
        }, 1000);
    </script>
</body>
</html>
