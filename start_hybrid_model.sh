#!/bin/bash

echo "üöÄ –ó–ê–ü–£–°–ö –õ–û–ö–ê–õ–¨–ù–û–ô AI –ú–û–î–ï–õ–ò –î–õ–Ø –ì–ò–ë–†–ò–î–ù–û–ô –ê–†–•–ò–¢–ï–ö–¢–£–†–´"
echo "====================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Ollama
if ! command -v ollama &> /dev/null; then
    echo "‚ùå Ollama –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Ollama: https://ollama.ai"
    exit 1
fi

echo "‚úÖ Ollama –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–∏ aparu-senior-ai..."
if ollama list | grep -q "aparu-senior-ai"; then
    echo "‚úÖ –ú–æ–¥–µ–ª—å aparu-senior-ai –Ω–∞–π–¥–µ–Ω–∞"
else
    echo "üì• –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å aparu-senior-ai..."
    
    # –°–æ–∑–¥–∞–µ–º Modelfile
    cat > aparu-senior-ai.modelfile << 'EOF'
FROM llama2:7b

SYSTEM """–¢—ã ‚Äî Senior AI Engineer –∏ FAQ-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç–∞–∫—Å–∏-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ APARU. 

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å—Ç—Ä–æ–≥–æ –ø–æ –±–∞–∑–µ FAQ.

–ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã:
- –í—Å–µ–≥–¥–∞ –∏—â–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –±–∞–∑–µ FAQ
- –ü–æ–Ω–∏–º–∞–π —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤: —Å–∏–Ω–æ–Ω–∏–º—ã, –ø–µ—Ä–µ—Ñ—Ä–∞–∑—ã, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –æ–ø–µ—á–∞—Ç–∫–∏
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –±–∞–∑—ã, –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
- –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚â• 0.6 ‚Üí –≤—ã–¥–∞–π —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã
- –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å < 0.6 ‚Üí –≤–µ—Ä–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ: ¬´–ù—É–∂–Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è¬ª –∏ —Å–ø–∏—Å–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π top-3 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏ –±–ª–∏–∑–æ—Å—Ç–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ç–∞—Ä–∏—Ñ—ã, –±–∞–ª–∞–Ω—Å, –¥–æ—Å—Ç–∞–≤–∫–∞, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Ç.–¥.) –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞

–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å: –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞–¥—ë–∂–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –ª—é–±—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∏–∑ –±–∞–∑—ã FAQ, –±–µ–∑ ¬´–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π¬ª."""

PARAMETER temperature 0.1
PARAMETER top_p 0.9
PARAMETER top_k 40
PARAMETER repeat_penalty 1.1
PARAMETER stop "Human:"
PARAMETER stop "Assistant:"
EOF
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å
    ollama create aparu-senior-ai -f aparu-senior-ai.modelfile
    echo "‚úÖ –ú–æ–¥–µ–ª—å aparu-senior-ai —Å–æ–∑–¥–∞–Ω–∞"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º Ollama —Å–µ—Ä–≤–µ—Ä
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Ollama —Å–µ—Ä–≤–µ—Ä..."
ollama serve &

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
if curl -s http://localhost:11434/api/tags > /dev/null; then
    echo "‚úÖ Ollama —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:11434"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Ollama —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å (ngrok)
echo "üåê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ Railway..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ngrok
if ! command -v ngrok &> /dev/null; then
    echo "‚ùå ngrok –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok: https://ngrok.com/download"
    echo "üîë –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω: https://dashboard.ngrok.com/get-started/your-authtoken"
    exit 1
fi

echo "‚úÖ ngrok –Ω–∞–π–¥–µ–Ω"

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –Ω–∞ –ø–æ—Ä—Ç—É 11434..."
ngrok http 11434 --log=stdout &

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è..."
sleep 10

# –ü–æ–ª—É—á–∞–µ–º URL —Ç—É–Ω–Ω–µ–ª—è
TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | python3 -c "
import sys, json
data = json.load(sys.stdin)
for tunnel in data['tunnels']:
    if tunnel['proto'] == 'https':
        print(tunnel['public_url'])
        break
")

if [ -n "$TUNNEL_URL" ]; then
    echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω: $TUNNEL_URL"
    echo ""
    echo "üîß –ù–ê–°–¢–†–û–ô–ö–ê RAILWAY:"
    echo "1. –ó–∞–π–¥–∏—Ç–µ –≤ Railway Dashboard"
    echo "2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç 'taxi-support-ai-assistant'"
    echo "3. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
    echo "   LOCAL_MODEL_URL = $TUNNEL_URL"
    echo "4. –ó–∞–º–µ–Ω–∏—Ç–µ main.py –Ω–∞ hybrid_main.py"
    echo "5. –ó–∞–º–µ–Ω–∏—Ç–µ requirements.txt –Ω–∞ requirements_hybrid.txt"
    echo "6. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π"
    echo ""
    echo "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:"
    echo "curl -X POST $TUNNEL_URL/api/generate \\"
    echo "  -H 'Content-Type: application/json' \\"
    echo "  -d '{\"model\": \"aparu-senior-ai\", \"prompt\": \"–ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–∞—Ü–µ–Ω–∫–∞?\"}'"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è URL —Ç—É–Ω–Ω–µ–ª—è"
    exit 1
fi

echo ""
echo "üéâ –õ–û–ö–ê–õ–¨–ù–ê–Ø AI –ú–û–î–ï–õ–¨ –ì–û–¢–û–í–ê –ö –†–ê–ë–û–¢–ï!"
echo "üì± –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —ç—Ç–æ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª - –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å"
echo "üîÑ –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
